DP.define(["dom/dimension"],function(m,l){var g=DP.DOM,h=l("dom/dimension"),f=function(){},i=[],j=!1,e=function(a,b){var c={data:[],className:"autocompleter",activeClass:"ac_select",onSelect:f,onShow:f,onHide:f,onHover:f,onLeave:f,onComplete:f,styles:{zIndex:999,position:"absolute",zoom:1},offsetTop:0,offsetLeft:0,itemTemplate:f,text:f},d=this;this.showLock=!1;i.push(this);j||(j=!0,g(document).on("click",function(){i.forEach(function(a){a.hide()})}));this.input=g(a);this.input.count()&&(this.options=
DP.mix(c,b),this.selectedItem=null,this.selectedIndex=-1,this.input.on("keydown",function(a){d.command(a)}),this.input.on("keyup",function(a){d.keyInput(a)}),this.ul=g.create("ul",{"class":this.options.className}).inject(document.body).on({mouseenter:function(){d.options.onHover()},mouseleave:function(){d.options.onLeave();var a=d.options.activeClass;d.ul.children().removeClass(a);d.ul.removeClass(a)}}),this.hide(),this.cacheValue=null)};e.prototype={constructor:e,command:function(a){switch(a.code){case 40:this.down();
a.prevent();break;case 38:this.up();a.prevent();break;case 13:this.complete()}},keyInput:function(a){if(-1===[37,38,39,40,13].indexOf(a.code)){var a=this.input.val(),b=this;a!==this.cacheValue&&(b.originValue=a,b.selectedItem=null,b.cacheValue=a,b.change(a,function(){b.empty();b.show();b.render()}))}},hide:function(){this.ul.css("display","none");this.showLock=!1},show:function(){var a=this.options,b=h.offset(this.input);this.ul.css(a.styles).css({display:"block",left:b.left+a.offsetLeft,top:b.top+
h.size(this.input).height+a.offsetTop});this.showLock||(this.options.onShow(),this.showLock=!0)},empty:function(){this.ul.children().dispose()},render:function(){var a=[],b=this;this.selectedIndex=-1;b.options.data.length?(b.options.data.forEach(function(c,d){a.push(b.options.itemTemplate.call(b,d))}),b.ul.html(a.join("")),b.bind()):b.hide()},bind:function(){var a=this;this.ul.children().forEach(function(b,c){g(b).on({click:function(){a.select(c);a.complete()},mouseenter:function(){}})})},change:function(){},
select:function(a){this.selectedIndex=a;this.input.val(this.options.text.call(this,a));this.hover(this.ul.children().get(a));this.options.onSelect()},hover:function(a){var b=this.options.activeClass;this.ul.children().removeClass(b);g(a).addClass(b);this.selectedItem=g(a)},complete:function(){this.hide();this.options.onComplete()},up:function(){0>=this.selectedIndex||this.select(--this.selectedIndex)},down:function(){this.selectedIndex!=this.options.data.length-1&&this.select(++this.selectedIndex)},
plugin:function(a,b){var c;if(c=e.typeStack[a]){for(var d in c)this[d]=c[d];DP.mix(this.options,b||{})}return this}};e.typeStack={};e.extend=function(a,b){this.typeStack[a]=b};var k="@163.com @qq.com @gmail.com @hotmail.com @sina.com @yahoo.com.cn @sohu.com @139.com".split(" ");e.extend("mail",{change:function(a,b){var c,d,f,e=this.options;""==a?(this.options.data=[],this.hide()):(-1==(c=a.indexOf("@"))?e.data=k.slice(0).map(function(b){return a+b}):(f=a.substr(0,c),d=a.substr(c),e.data=[],k.forEach(function(a){-1!=
a.indexOf(d)&&e.data.push(f+a)})),b())}});e.extend("ajax",{change:function(a,b){var c=this;DP.provide("io/ajax",function(d,e){(new e({url:c.options.ajaxUrl,method:"post",data:c.ajaxData(a)})).on({success:function(a){a&&200==a.code?(c.options.data=c.processData(a),b()):c.hide()}}).send()})},ajaxData:function(a){this.ajaxData=a;return this},processData:function(a){this.processData=a;return this}});return e});
