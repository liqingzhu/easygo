DP.define(["comm::util","io/ajax","comm::mbox"],function(d,g){g("comm::util");return d.Class({_defaultOptions:{ajaxUrl:"/ajax/search",href:"/list"},initialize:function(b,c){var a=this;this.node=b;this.options=c?d.mix(this._defaultOptions,c):this._defaultOptions;this.$searchForm=this.node.one("[data-id=search-form]");this.$searchBtn=this.node.one("[data-id=search-button]");this.$searchInput=this.node.one("[data-id=search-input]");this.options.href=this.$searchForm.attr("action");this.$searchBtn.on("click",
function(a){a.prevent()});d.provide("comm::placeholder",function(b,c){a._initSuggest(a.$searchInput);a.placeholder=new c(a.$searchInput,{btn:a.$searchBtn,exec:function(){a._doSearch(a.placeholder,a.$searchInput)}})})},_doSearch:function(b,c){var a=b.getValue().trim(),e=location.search,d,f={},h=["sort","desc"];a&&a.replace(c.attr("placeholder"),"")&&(c.val(a),e=e.split(/\?|&/),e.forEach(function(a){a=a.split("=");a[0]&&(f[a[0]]=a[1]||"")}),d=["?q="+encodeURIComponent(a.replace(c.attr("placeholder"),
""))],h.forEach(function(a){a in f&&d.push(a+"="+f[a])}),this.$searchForm.el(0).submit())},changeAction:function(b){var c="",c=0<=b.indexOf("{city}")?b.replace("{city}",d.data("cityEnName")):-1>=b.indexOf(d.data("cityEnName"))?d.data("cityEnName")+b:b;this.$searchForm.attr("action",c)},_initSuggest:function(b){var c=this,a=!1,e=function(){a||(a=!0,d.provide("comm::suggest",function(d,e){a=new e(b,{onComplete:function(){c._doSearch(c.placeholder,b)},onShow:function(){},className:"tg-search-suggest",
itemTemplate:function(a){return"<li>"+this.options.data[a].key.replace(b.val(),"<em>"+b.val()+"</em>")+'<span class="tips">约'+this.options.data[a].value+"个结果</span></li>"},text:function(a){return this.options.data[a].key},activeClass:"this",ajaxUrl:c.options.ajaxUrl,offsetLeft:-12,offsetTop:11});a.plugin("ajax").processData(function(a){return a.msg.list}).ajaxData(function(a){return{action:"suggest",word:a}})}))};b.on("keyup",e);b.on("focus",e)},renderHotWords:function(b){var c=this.node.one("[data-id=hot-words]"),
a="";(b=b.data.searchWords)&&b.length&&b.forEach(function(b,c){var f='<a track="dp_tg_'+d.data("cityEnName")+"_hotwords_test|1|module#2_nav_hotkw,action#click,index#"+(c+1)+",content#"+b.url+'" href="'+b.url+'"><span>'+b.keyWord+"</span></a>";a+=f});c.html(a)}})});
