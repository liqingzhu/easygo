DP.define(["comm::options-from-dataset"],function(e,f){var g=f("comm::options-from-dataset");return e.Class({data:{},name:"default",persistanceLevel:"page",initialize:function(a,c){this.scope=a;this.options=c||{};this.name=this.options.name||this.name;this.persistanceLevel=this.options.persistanceLevel||this.persistanceLevel;"page"!==this.persistanceLevel&&"undefined"===typeof Storage&&(this.persistanceLevel="page")},bind:function(a){e.mix(this.data,a);this.store(a)},fetch:function(a,c,d){var b=this.options.data;
switch(this.persistanceLevel){case "page":this._$dataContainer=this.scope.one("[data-id="+this.name+"-data]");if(!this._$dataContainer.count()||a){try{this.clear(),$.create("div",{"data-id":this.name+"-data","data-type":this.name,"data-eval-config":this._stringifyJSON(b||{}),style:"display:none"}).inject(this.scope),this._$dataContainer=this.scope.one("[data-id="+this.name+"-data]")}catch(e){throw new ReferenceError("持久化容器["+this.name+"-data]创建失败");}this.bind(b||{});this.fetchData(c,d)}else b=b||
this._parseJSON(this._$dataContainer.attr("data-eval-config")),this.bind(b||{}),this.getCurrent(d);break;case "session":!sessionStorage.getItem(this.name+"-data")||a?(this.clear(),sessionStorage.setItem(this.name+"-data",this._stringifyJSON(b||{})),this.bind(b||{}),this.fetchData(c,d)):(b=b||this._parseJSON(sessionStorage.getItem(this.name+"-data")),this.bind(b||{}),this.getCurrent(d));break;case "browser":!localStorage.getItem(this.name+"-data")||a?(this.clear(),localStorage.setItem(this.name+"-data",
this._stringifyJSON(b||{})),this.bind(b||{}),this.fetchData(c,d)):(b=b||this._parseJSON(localStorage.getItem(this.name+"-data")),this.bind(b||{}),this.getCurrent(d))}},fetchData:function(a,c){try{this._fetchData(a,c)}catch(d){throw new ReferenceError("使用参数["+a+"]获取数据出现异常");}},_fetchData:function(){},getCurrent:function(a){var c={};switch(this.persistanceLevel){case "page":try{c=g(this._$dataContainer.el(0)).config||{}}catch(d){throw new ReferenceError("从HTML持久化容器["+this.name+"-data]获取数据出现异常");}break;
case "session":try{c={}}catch(b){throw new ReferenceError("从 session storage 持久化容器["+this.name+"-data]获取数据出现异常");}break;case "browser":try{c={}}catch(f){throw new ReferenceError("从 local storage 持久化容器["+this.name+"-data]获取数据出现异常");}}e.mix(this.data,c);a&&a.call(this,this.data)},store:function(a){switch(this.persistanceLevel){case "page":this._$dataContainer.attr("data-eval-config",this._stringifyJSON(a));break;case "session":sessionStorage.setItem(this.name+"-data",this._stringifyJSON(a));break;case "browser":localStorage.setItem(this.name+
"-data",this._stringifyJSON(a))}},clear:function(){switch(this.persistanceLevel){case "page":this._$dataContainer.dispose();break;case "session":sessionStorage.removeItem(this.name+"-data");break;case "browser":localStorage.removeItem(this.name+"-data")}},_stringifyJSON:function(a){try{return JSON.stringify(a)}catch(c){throw new SyntaxError("序列化JSON数据["+data+"]失败");}},_parseJSON:function(a){try{return JSON.parse(a)}catch(c){throw new SyntaxError("解析JSON数据["+data+"]失败");}}})});
